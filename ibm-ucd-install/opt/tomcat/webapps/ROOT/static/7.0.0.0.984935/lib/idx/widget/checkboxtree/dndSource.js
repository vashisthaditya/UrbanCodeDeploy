//>>built
define("idx/widget/checkboxtree/dndSource","dojo/_base/declare,dojo/_base/connect,dojo/_base/array,dojo/_base/lang,dojo/_base/event,idx/dnd/Manager,dojo/mouse,dojo/dom-class,dojo/dom-geometry,./_dndSelector".split(","),function(p,j,k,l,q,i,t,n,r,s){return p("idx.widget.checkboxtree.dndSource",s,{isSource:!0,accept:["text","treeNode"],copyOnly:!1,dragThreshold:5,betweenThreshold:0,constructor:function(a,b){b||(b={});l.mixin(this,b);this.isSource="undefined"==typeof b.isSource?!0:b.isSource;var e=b.accept instanceof
Array?b.accept:["text","treeNode"];this.accept=null;if(e.length){this.accept={};for(var c=0;c<e.length;++c)this.accept[e[c]]=1}this.mouseDown=this.isDragging=!1;this.targetBox=this.targetAnchor=null;this.dropPosition="";this._lastY=this._lastX=0;this.sourceState="";this.isSource&&n.add(this.node,"dojoDndSource");this.targetState="";this.accept&&n.add(this.node,"dojoDndTarget");this.topics=[j.subscribe("/dnd/source/over",this,"onDndSourceOver"),j.subscribe("/dnd/start",this,"onDndStart"),j.subscribe("/dnd/drop",
this,"onDndDrop"),j.subscribe("/dnd/cancel",this,"onDndCancel")]},checkAcceptance:function(){return!0},copyState:function(a){return this.copyOnly||a},destroy:function(){this.inherited("destroy",arguments);k.forEach(this.topics,j.unsubscribe);this.targetAnchor=null},_onDragMouse:function(a){var b=i.manager(),e=this.targetAnchor,c=this.current,h=this.dropPosition,f=!1;if(b.source.tree.model instanceof dijit.tree.ForestStoreModel)for(var g=b.source.tree.rootNode.getChildren(),d=0;d<g.length;d++){if(g[d].id in
b.source.selection){f=!0;break}}else b.source.tree.rootNode.id in b.source.selection&&(f=!0);g="Over";if(!f&&c){if(c&&0<this.betweenThreshold){if(!this.targetBox||e!=c)this.targetBox=r.position(c.rowNode,!0);a.pageY-this.targetBox.y<=this.betweenThreshold?g="Before":a.pageY-this.targetBox.y>=this.targetBox.h-this.betweenThreshold&&(g="After")}if(c!=e||g!=h){e&&this._removeItemClass(e.rowNode,h);c&&this._addItemClass(c.rowNode,g);if(c)if((c==this.tree.rootNode||this.tree.model instanceof dijit.tree.ForestStoreModel&&
c.getParent()==this.tree.rootNode)&&"Over"!=g)b.canDrop(!1);else if(b.source==this&&c.id in this.selection)b.canDrop(!1);else if(this.checkItemAcceptance(c.rowNode,b.source,g.toLowerCase())&&!this._isParentChildDrop(b.source,c.rowNode)){var a=!0,o;for(o in b.source.selection)if(b.source.selection[o].item==c.item){a=!1;break}b.canDrop(a)}else b.canDrop(!1);else b.canDrop(!1);this.targetAnchor=c;this.dropPosition=g}}else b.canDrop(!1)},onMouseMove:function(a){if(!(this.isDragging&&"Disabled"==this.targetState)){var b=
i.manager();if(this.isDragging)this._onDragMouse(a);else if(this.mouseDown&&this.isSource&&(Math.abs(a.pageX-this._lastX)>=this.dragThreshold||Math.abs(a.pageY-this._lastY)>=this.dragThreshold)){var e=this.getSelectedTreeNodes();if(e.length&&!(1==e.length&&!1===e[0].checkboxNode.checked)){if(1<e.length){var c=this.selection,h=0,f=[],g,d;a:for(;g=e[h++];){for(d=g.getParent();d&&d!==this.tree;d=d.getParent())if(c[d.id])continue a;f.push(g)}e=f}e=k.map(e,function(a){return a.domNode});b.startDrag(this,
e,this.copyState(j.isCopyKey(a)))}else this.isDirectDnD=!0,this.setSelection([this.candidateNode]),b.startDrag(this,[this.candidateNode.domNode],this.copyState(j.isCopyKey(a)))}}},onMouseDown:function(a){this.mouseDown=!0;this.mouseButton=a.button;this._lastX=a.pageX;this._lastY=a.pageY;q.stop(a);this.inherited(arguments)},onMouseUp:function(a){if(this.mouseDown)this.mouseDown=!1,this.inherited(arguments)},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor()},checkItemAcceptance:function(){return!0},
onDndSourceOver:function(a){this!=a?(this.mouseDown=!1,this._unmarkTargetAnchor()):this.isDragging&&i.manager().canDrop(!1)},onDndStart:function(a,b,e){this.isSource&&this._changeState("Source",this==a?e?"Copied":"Moved":"");this._changeState("Target",this.checkAcceptance(a,b)?"":"Disabled");this==a&&i.manager().overSource(this);this.isDragging=!0},itemCreator:function(a,b){return k.map(a,function(a){for(var c=dijit.byNode(a).item,h=b.tree.model.store,a=h.getIdentityAttributes(c),f={},g="id",d=a.length-
1;0<=d;--d)f[a[d]]=h.getValue(c,a[d]),g=a[d];h.fetchItemByIdentity({identity:g,onItem:function(){f[g]=h.getValue(c,g)+(new Date).getTime()},scope:this});f.name=h.getValue(c,"name");return f},this)},onDndDrop:function(a,b,e){if("Over"==this.containerState){var c=this.tree,h=c.model,f=this.targetAnchor;this.isDragging=!1;var g,d;g=f&&f.item||c.item;"Before"==this.dropPosition||"After"==this.dropPosition?(g=f.getParent()&&f.getParent().item||c.item,d=f.getIndexInParent(),"After"==this.dropPosition&&
(d=f.getIndexInParent()+1)):g=f&&f.item||c.item;var j=function(b,c,g,e,d){var f=dijit.byNode(b),i=d.itemCreator([b],a,h.store);h.newItem(i[0],c,g);d.tree.toggleNode(i[0].id,e);b=f.getChildren();k.forEach(b,function(a,b){d.tree.model.store.fetchItemByIdentity({identity:i[0].id,onItem:l.hitch(d,function(c){j(a.domNode,c,b,e,this)})})},this)},i=function(b){var c=b.getChildren();k.forEach(c,function(a){i(a)},this);a.selection[b.id]&&a.removeTreeNode(b);a.tree.model.store.deleteItem(b.item)};k.forEach(b,
function(b){var c=a.getItem(b.id);if(-1!=k.indexOf(c.type,"treeNode"))var f=c.data,m=f.item,l=f.getParent().item;c=f.checkboxNode.checked;f.getParent().getChildren();h.isItem(m)?(a==this&&"number"==typeof d&&g==l&&f.getIndexInParent()<d&&(d-=1),e?j(b,g,d,c,this):h.pasteItem(m,l,g,e,d),this.tree.toggleNode(m.id[0],c)):(j(b,g,d,c,this),e||(b=dijit.byNode(b),i(b),a.tree.model.store.save()))},this);this.tree._expandNode(f)}this.onDndCancel()},onDndCancel:function(){this._unmarkTargetAnchor();this.mouseDown=
this.isDragging=!1;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","");if(!0==this.isDirectDnD)this.isDirectDnD=!1},onOverEvent:function(){this.inherited(arguments);i.manager().overSource(this)},onOutEvent:function(){this._unmarkTargetAnchor();var a=i.manager();this.isDragging&&a.canDrop(!1);a.outSource(this);this.inherited(arguments)},_isParentChildDrop:function(a,b){if(!a.tree||a.tree!=this.tree)return!1;for(var e=a.tree.domNode,c=a.selection,h=b.parentNode;h!=
e&&!c[h.id];)h=h.parentNode;return h.id&&c[h.id]},_unmarkTargetAnchor:function(){if(this.targetAnchor)this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition),this.dropPosition=this.targetBox=this.targetAnchor=null},_markDndStatus:function(a){this._changeState("Source",a?"Copied":"Moved")}})});