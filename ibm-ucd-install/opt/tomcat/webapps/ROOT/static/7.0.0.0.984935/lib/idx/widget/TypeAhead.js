//>>built
define("idx/widget/TypeAhead","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/_base/json,dojo/_base/html,dojo/_base/connect,dojo/_base/xhr,dojo/window,dojo/query,dojo/keys,dijit/popup,dijit/_Widget,dijit/_TemplatedMixin,idx/util,idx/resources".split(","),function(j,g,h,o,d,f,k,p,i,e,l,m,q,r,s){var n,t=j("idx.widget.TypeAhead",[m],{connectedNode:"",isShowing:!1,type:"store",store:null,labelAttr:"name",valueAttr:"value",queryOptions:{ignoreCase:!0},url:"",encode:!1,polling:!0,_pollingTimer:null,
pollingInterval:500,_lastValue:"",_popupWidget:null,closable:!1,persist:!1,_previousRequest:null,timeout:3E3,cacheEnabled:!0,_cachedMap:[],_blurTimer:null,blurInterval:300,_handlers:[],method:"POST",constructor:function(){this._handlers=[];this._cachedMap=[]},buildRendering:function(){this.inherited(arguments);this._popupWidget=new n({onClick:g.hitch(this,this._onClick),onClose:g.hitch(this,this._onClose),id:this.id+"_popup",closable:this.closable,dir:this.dir})},postCreate:function(){this.inherited(arguments);
this.attachHandlers(this.connectedNode=this.getNodeById(this.connectedNode))},startup:function(){this._started||(this.inherited(arguments),this._popupWidget.startup())},attach:function(a){if((a=this.getNodeById(a))&&this.connectedNode!=a)this.detach(),this.attachHandlers(a),this.connectedNode=a},attachHandlers:function(a){a&&(this._handlers.push(f.connect(a,"onkeyup",this,"_onInputKeyup")),this._handlers.push(f.connect(a,"onblur",this,"_onBlur")),this._handlers.push(f.connect(a,"onkeydown",this,"_onInputKeyDown")),
this._handlers.push(f.connect(window,"onresize",this,"hideResults")),r.isFF||this._handlers.push(f.connect(this._popupWidget.domNode,"onmousedown",this,function(){this._popupScrollbarClicked=!0})))},getNodeById:function(a){return!a?null:a.nodeName&&1==a.nodeType?a:d.byId(a)},detach:function(){this.clearResults();this._lastValue="";h.forEach(this._handlers,f.disconnect);this.clearCache();this.clearPollingTimer();this.connectedNode=null},_onInputKeyup:function(a){var b=a.keyCode,b=!(b==e.UP_ARROW||
b==e.DOWN_ARROW||b==e.LEFT_ARROW||b==e.RIGHT_ARROW),a=a.target.value;!this.polling&&b&&a!=this._lastValue&&this.loadSuggestions(a)},_onInputKeyDown:function(a){switch(a.keyCode){case e.ENTER:this.abortRequest();this._onExecute();this._lastValue=a.target.value;break;case e.PAGE_UP:case e.UP_ARROW:this.clearPollingTimer();this._onKeyUpArrow();break;case e.PAGE_DOWN:case e.DOWN_ARROW:this.clearPollingTimer();this._onKeyDownArrow();break;case e.LEFT_ARROW:case e.RIGHT_ARROW:this.clearPollingTimer();break;
case e.ESCAPE:this.setDisplayedValue(this._lastValue);this.hideResults();break;default:this.polling&&null==this._pollingTimer&&this._onStartPolling(!0)}},_onStartPolling:function(a){var b=this;if(a||null!=b._pollingTimer)b._pollingTimer=setTimeout(function(){var a=b.connectedNode.value;b._lastValue!=a&&b.loadSuggestions(a);b._onStartPolling(!1)},a?0:b.pollingInterval)},loadSuggestions:function(a){this._lastValue=a;if(""==g.trim(a))this.abortRequest(),this.clearResults(),this._lastValue="";else{if(this.cacheEnabled){var b=
this.loadFromCache(a);if(b){this.renderResults(b,!0);return}}this.store?this.loadStoreSuggestions(a):this.remoteLoadSuggestions(a)}},remoteLoadSuggestions:function(a){this.encode&&(a=encodeURIComponent(a));a={url:this.url,content:this.getContentParam(a),load:g.hitch(this,function(a){this.renderResults(a,!1)}),timeout:this.timeout};this.abortRequest();this._previousRequest="post"==this.method.toLowerCase()?k("POST",a):k("GET",a)},loadStoreSuggestions:function(a){var b=this,c=this.labelAttr,d=this.valueAttr,
e=[],f={};f[c]=a+"*";this.store.fetch({query:f,queryOptions:this.queryOptions,onItem:function(a){e.push({label:a[c][0],value:a[d][0]})},onComplete:function(){var a=b.jsonToHtml(e);b.renderResults(a,!1)}})},getContentParam:function(a){return{prefix:a}},abortRequest:function(){var a=this._previousRequest;if(a)a.canceled=!0,a.ioArgs.xhr.abort()},loadFromCache:function(a){for(var b=this._cachedMap,c=b.length-1;0<=c;c--)if(b[c][0]==a)return b[c][1];return!1},renderResults:function(a,b){this.clearResults();
if(this._popupWidget.render("json"==this.type.toLowerCase()?this._jsonToHtml(a):a))this.showResults(),this._popupWidget.attachHandlers();this.cacheEnabled&&!b&&this._cachedMap.push([this._lastValue,a])},_jsonToHtml:function(a){var b=null;try{b=o.fromJson(a)}catch(c){return}return this.jsonToHtml(b)},jsonToHtml:function(a){for(var b=["<table class='typeAheadTable'><tbody>"],c=0,d=a.length;c<d;c++)b.push("<tr class='"),b.push(0==c%2?"typeAheadTableRow":"typeAheadTableRow typeAheadTableRowOdd"),b.push("'><td class='typeAheadTableCell' value='"),
b.push(a[c].value),b.push("'>"),b.push(a[c].label),b.push("</td></tr>");b.push("</tbody></table>");return b.join("")},clearCache:function(){this._cachedMap=[]},clearResults:function(){this.hideResults();this._popupWidget.clearList()},hideResults:function(){l.close(this._popupWidget);this.isShowing=!1;d.style(this.domNode,"display","none")},showResults:function(){if(this._popupWidget.domNode.firstChild)l.open({popup:this._popupWidget,around:this.connectedNode}),this.isShowing=!0,this._popupWidget.setWidth(d.marginBox(this.connectedNode).w),
this._popupWidget.adjustScrollBar()},_onKeyUpArrow:function(){this._onKeyUpDownArrow(-1)},_onKeyDownArrow:function(){this._onKeyUpDownArrow(1)},_onKeyUpDownArrow:function(a){var c;if(this.isShowing){var b=this._popupWidget;b.selectNextNode(a);c=(a=b._selectedNode)?a.firstChild:null,b=c;a&&b&&d.attr(b,"value")?this.setDisplayedValue(d.attr(b,"value")):this.setDisplayedValue(this._lastValue)}else this.showResults()},_onBlur:function(){if(this.isShowing)this._blurTimer=setTimeout(g.hitch(this,function(){this._blurTimer=
null;if(!this.persist)this._popupScrollbarClicked?this.connectedNode.focus():this.hideResults(),this._popupScrollbarClicked=!1}),this.blurInterval);this.clearPollingTimer();this.onBlur()},onBlur:function(){},clearPollingTimer:function(){if(null!=this._pollingTimer)clearTimeout(this._pollingTimer),this._pollingTimer=null},_onClick:function(a){var b=this._popupWidget._selectedNode;b&&b.firstChild&&this.setDisplayedValue(d.attr(b.firstChild,"value"));this.hideResults();this.onClick(a)},onClick:function(){},
_onExecute:function(){this.hideResults();setTimeout(g.hitch(this,this.onExecute))},onExecute:function(){},_onClose:function(){this.hideResults()},setDisplayedValue:function(a){this.connectedNode.value=a},getDisplayedValue:function(){return this.connectedNode.value},clearBlurTimer:function(){null!=this._blurTimer&&clearTimeout(this._blurTimer)},_setUrlAttr:function(a){this.url!=a&&(this.detach(),this.attachHandlers(this.connectedNode));this.url=a},setStore:function(a){this.store=a},destroy:function(){this._popupWidget.destroy();
h.forEach(this._handlers,f.disconnect);this.inherited(arguments)}});n=j("idx.widget._TypeAheadPopup",[m,q],{templateString:"<div class='idxTypeAhead'></div>",_selectedNode:null,res:null,_handlers:[],constructor:function(){this._handlers=[]},postMixInProperties:function(){this.inherited(arguments);this.res=s.getResources("idx/widget/TypeAhead",this.lang)},postCreate:function(){this.inherited(arguments);this.connect(this.domNode,"onfocus","_onFocus")},render:function(a){this.domNode.innerHTML=a;a=this.domNode.firstChild;
if(!(a&&"TABLE"==a.tagName))return!1;return 0<i("tr",a).length?(this._showList(),!0):!1},attachHandlers:function(){var a=i("tr",this.domNode.firstChild),b=a.length;h.forEach(a,function(a){this._handlers.push(f.connect(a,"onmouseover",this,function(b){this._onMouseOver(b,a)}));this._handlers.push(f.connect(a,"onclick",this,function(b){this._onClick(b,a)}))},this);if(this.closable&&0<b)a=d.create("tr",{className:0==b%2?"typeAheadTableRow":"typeAheadTableRow typeAheadTableRowOdd"},a[b-1],"after"),a=
d.create("td",{className:"typeAheadTableCell typeAheadCloseNode"},a),d.create("a",{href:"javascript:;",title:this.res.idxTypeAhead_close,innerHTML:this.res.idxTypeAhead_close},a).onclick=this.onClose},_showList:function(){d.style(this.domNode,"display","")},selectNextNode:function(a){if(this.domNode.firstChild)this._selectedNode?(a=this._getNextNode(a),this._removeSelectedClass(),a?this._selectNode(a):this._selectedNode=null):this._selectFirstOrLastNode(a)},_getNextNode:function(a){var b=this.domNode.firstChild;
if(null!=b)for(var b=i("tr",b),c=0,d=b.length;c<d;c++)if(this._selectedNode==b[c])return 0>a?b[c-1]:b[c+1];return null},_selectFirstOrLastNode:function(a){var b=this.domNode.firstChild;if(null!=b){var b=i("tr",b),c=b.length;0<c&&this._selectNode(b[0>a?c-1:0])}},_selectNode:function(a){if(a&&"TR"==a.tagName)d.addClass(a,"typeAheadTableRowSelected"),this._selectedNode=a,this.adjustScrollBar()},_onMouseOver:function(a,b){this._removeSelectedClass();this._selectNode(b)},_onClick:function(a,b){this._removeSelectedClass();
this._selectNode(b);this.onClick(a)},onClick:function(){},onClose:function(){},_onFocus:function(){},_removeSelectedClass:function(){var a=this._selectedNode;a&&d.removeClass(a,"typeAheadTableRowSelected")},clearList:function(){this._selectedNode=null;h.forEach(this._handlers,f.disconnect);d.empty(this.domNode)},setWidth:function(a){d.marginBox(this.domNode,{w:a})},adjustScrollBar:function(){var a=this.domNode.firstChild;if(a&&d.contentBox(this.domNode).h<d.contentBox(a).h)a=this._selectedNode,null!=
a&&p.scrollIntoView(a)},destroy:function(){h.forEach(this._handlers,f.disconnect);this.inherited(arguments)}});return t});